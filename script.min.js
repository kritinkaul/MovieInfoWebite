const API_KEY='cc5175108a6220906a5790b74539b1b9',API_URL='https://api.themoviedb.org/3',CACHE_DURATION=5*60*1e3,DEBOUNCE_DELAY=300,IMAGE_BASE_URL='https://image.tmdb.org/t/p/',apiCache=new Map;function debounce(e,t){let n;return function(...o){const s=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(s,t)}}async function cachedFetch(e,t){const n=apiCache.get(t);if(n&&Date.now()-n.timestamp<CACHE_DURATION)return n.data;try{const n=await fetch(e);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();return apiCache.set(t,{data:o,timestamp:Date.now()}),o}catch(e){console.error('Fetch error:',e),throw e}}function createOptimizedImage(e,t,n,o='w300'){const s=document.createElement('img');return s.loading='lazy',s.src=`${IMAGE_BASE_URL}${o}${e}`,s.alt=t,n&&(s.className=n),s.onerror=function(){this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'},s}async function fetchMovieDetailsBatch(e){const t=e.map(e=>cachedFetch(`${API_URL}/movie/${e}?api_key=${API_KEY}&append_to_response=watch/providers`,`movie_${e}`));try{const e=await Promise.allSettled(t);return e.map(e=>'fulfilled'===e.status?e.value:null).filter(Boolean)}catch(e){return console.error('Error fetching movie details batch:',e),[]}}async function fetchMovieDetails(e){try{const t=await cachedFetch(`${API_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(e)}`,`search_${e}`);t.results&&t.results.length>0?displayMovie(t.results[0]):showNotification('Movie not found!','error')}catch(e){console.error('Error fetching movie details:',e),showNotification('Error fetching movie details','error')}}async function fetchTopMovies(){try{const e=await cachedFetch(`${API_URL}/movie/popular?api_key=${API_KEY}&language=en-US&page=1`,'top_movies');e.results&&await displayTopMoviesOptimized(e.results.slice(0,10))}catch(e){console.error('Error fetching top movies:',e),showNotification('Error loading top movies','error')}}async function displayTopMoviesOptimized(e){const t=document.getElementById('movie-list');t.innerHTML='<div class="loading">Loading movies...</div>';try{const n=e.map(e=>e.id),o=await fetchMovieDetailsBatch(n);t.innerHTML='',e.forEach((e,s)=>{const a=o[s],i=a?.['watch/providers']?.results?.US?.flatrate||[],c=i.map(e=>e.provider_name).join(', ')||"Not Available",r=document.createElement('div');r.classList.add('movie-card');const l=createOptimizedImage(e.poster_path,e.title,'movie-poster','w200');r.innerHTML=`<div class="movie-poster-container"></div><div class="movie-info"><h4>${e.title}</h4><p class="movie-rating">‚≠ê ${e.vote_average||'N/A'}</p><p class="movie-release-date">Release Date: ${e.release_date||'N/A'}</p><p class="movie-streaming"><strong>Streaming on:</strong> ${c}</p></div>`,r.querySelector('.movie-poster-container').appendChild(l),t.appendChild(r)})}catch(e){console.error('Error displaying movies:',e),t.innerHTML='<div class="error">Error loading movies</div>'}}async function displayMovie(e){const t=document.getElementById('movie-details');t.innerHTML='<div class="loading">Loading movie details...</div>';try{const n=await cachedFetch(`${API_URL}/movie/${e.id}?api_key=${API_KEY}&append_to_response=credits,watch/providers`,`movie_details_${e.id}`),o=n.credits?.cast?.slice(0,5).map(e=>e.name).join(', ')||'Not Available',s=n.production_countries?.map(e=>e.name).join(', ')||'Not Available',a=n['watch/providers']?.results?.US?.flatrate||[],i=a.map(e=>e.provider_name).join(', ')||'Not Available',c=createOptimizedImage(e.poster_path,e.title,'movie-poster');t.innerHTML=`<div class="movie-info-container"><div class="movie-poster-container"></div><div class="movie-info"><h3>${e.title}</h3><p><i class="fas fa-calendar-alt"></i> <strong>Release Date:</strong> ${e.release_date}</p><p><i class="fas fa-info-circle"></i> <strong>Overview:</strong> ${e.overview}</p><p><i class="fas fa-users"></i> <strong>Actors:</strong> ${o}</p><p><i class="fas fa-globe"></i> <strong>Country:</strong> ${s}</p><p><i class="fas fa-tv"></i> <strong>Streaming on:</strong> ${i}</p></div></div>`,t.querySelector('.movie-poster-container').appendChild(c)}catch(e){console.error('Error displaying movie:',e),t.innerHTML='<div class="error">Error loading movie details</div>'}}function showNotification(e,t='info'){const n=document.createElement('div');n.className=`notification ${t}`,n.textContent=e,n.style.cssText=`position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 5px; color: white; z-index: 1000; background: ${'error'===t?'#f44336':'#4CAF50'};`,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}const debouncedFetchSuggestions=debounce(async e=>{if(!e.trim())return void(document.getElementById('suggestions-list').innerHTML='');try{const t=await cachedFetch(`${API_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(e)}`,`suggestions_${e}`);displaySuggestions(t.results)}catch(e){console.error('Error fetching suggestions:',e)}},DEBOUNCE_DELAY);function displaySuggestions(e){const t=document.getElementById('suggestions-list');t.innerHTML='',e.slice(0,5).forEach(e=>{const n=document.createElement('div');n.classList.add('suggestion-item');const o=createOptimizedImage(e.poster_path,e.title,'','w92');n.innerHTML=`<p>${e.title}</p>`,n.insertBefore(o,n.firstChild),n.addEventListener('click',()=>{displayMovie(e),t.innerHTML='',document.getElementById('search-bar').value=e.title}),t.appendChild(n)})}document.addEventListener('DOMContentLoaded',()=>{const e=document.getElementById('search-button'),t=document.getElementById('search-bar'),n=document.getElementById('suggestions-list');e.addEventListener('click',()=>{const e=t.value.trim();e&&fetchMovieDetails(e)}),t.addEventListener('input',e=>{const t=e.target.value.trim();debouncedFetchSuggestions(t)}),document.addEventListener('click',e=>{e.target.contains(t)||e.target.contains(n)||(n.innerHTML='')});let o;window.addEventListener('scroll',()=>{if(o)return;o=setTimeout(()=>{const e=document.getElementById('back-to-top'),t=window.pageYOffset||document.documentElement.scrollTop;t>200?e.style.display='block':e.style.display='none',o=null},100)}),fetchTopMovies()}),scrollToTop=()=>window.scrollTo({top:0,behavior:'smooth'}),setInterval(()=>{const e=Date.now();for(const[t,n]of apiCache.entries())e-n.timestamp>CACHE_DURATION&&apiCache.delete(t)},10*60*1e3),setInterval(fetchTopMovies,10*60*1e3);